# Set the oh-my-posh theme name globally
OMP_THEME_NAME="night-owl.omp.json"
# OMP_THEME_NAME="atomic.omp.json"
# OMP_THEME_NAME="clean-detailed.omp.json"
# OMP_THEME_NAME="jandedobbeleer.omp.json"
# OMP_THEME_NAME="kushal.omp.json"

# Initialize Homebrew first
if [ -f "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [ -f "/usr/local/bin/brew" ]; then
    eval "$(/usr/local/bin/brew shellenv)"
else
    echo "Homebrew not found" >&2
fi

# Now we can safely use brew commands
BREW_PREFIX="$(brew --prefix)/bin"

# Oh-my-posh theme setup (change OMP_THEME_NAME to switch themes)
if command -v "${BREW_PREFIX}/oh-my-posh" >/dev/null 2>&1 && command -v "${BREW_PREFIX}/brew" >/dev/null 2>&1; then
    OMP_THEME_CMD="$(${BREW_PREFIX}/oh-my-posh init zsh --config "$(${BREW_PREFIX}/brew --prefix oh-my-posh)/themes/$OMP_THEME_NAME")"
else
    echo "Could not set OMP_THEME_CMD" >&2
    OMP_THEME_CMD=""
fi

# Homebrew
if [ -x "$BREW_PREFIX/brew" ]; then
    eval "$($BREW_PREFIX/brew shellenv)"
fi

# Setup oh-my-posh theme if defined
if [ -n "$OMP_THEME_CMD" ]; then
    eval "$OMP_THEME_CMD"
fi

# Get all environment variables from the .env file
$(cat ~/.env | ${BREW_PREFIX}/op inject --)

# Set vi mode
set -o vi

# Python auto env setup
PYTHON_VENV_NAME=".venv"
PYTHON_AUTO_VRUN=true
PYTHON_VENV_NAMES=($PYTHON_VENV_NAME venv)

# Path to your Oh My Zsh installation
export ZSH="$HOME/.oh-my-zsh"

# Theme and plugins configuration
plugins=(git gh macos pip poetry python)

# Source Oh My Zsh
source $ZSH/oh-my-zsh.sh

# Load zsh plugins in correct order to avoid widget conflicts
# Critical: zsh-autocomplete creates widgets that syntax highlighting needs to know about

# 1. Load zsh-autocomplete FIRST (creates menu-search, recent-paths, insert-unambiguous-or-complete widgets)
if [ -f /opt/homebrew/share/zsh-autocomplete/zsh-autocomplete.plugin.zsh ]; then
    source /opt/homebrew/share/zsh-autocomplete/zsh-autocomplete.plugin.zsh

    # Configure zsh-autocomplete to reduce widget conflicts
    zstyle ':autocomplete:*' widget-style menu-search
    zstyle ':autocomplete:*' fzf-completion no
fi

# 2. Auto suggestions (compatible with autocomplete)
if [ -f /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh ]; then
    source /opt/homebrew/share/zsh-autosuggestions/zsh-autosuggestions.zsh
fi

# 3. History substring search (must be after autocomplete to avoid conflicts)
if [ -f /opt/homebrew/share/zsh-history-substring-search/zsh-history-substring-search.zsh ]; then
    source /opt/homebrew/share/zsh-history-substring-search/zsh-history-substring-search.zsh

    # Bind keys for history search (after autocomplete is loaded)
    bindkey '^[[A' history-substring-search-up
    bindkey '^[[B' history-substring-search-down
fi

# 4. Syntax highlighting MUST be loaded LAST (after all widgets are defined)
# Try standard zsh-syntax-highlighting first (better compatibility with zsh-autocomplete)
if [ -f /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh ]; then
    source /opt/homebrew/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
elif [ -f /opt/homebrew/opt/zsh-fast-syntax-highlighting/share/zsh-fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh ]; then
    # Fallback to fast-syntax-highlighting but with widget error suppression
    source /opt/homebrew/opt/zsh-fast-syntax-highlighting/share/zsh-fast-syntax-highlighting/fast-syntax-highlighting.plugin.zsh 2>/dev/null
fi

# Load environment variables from .env file with validation
REQUIRED_VARS=(GITHUB_TOKEN ANSIBLE_SUDO_PASS)
if [ -f "$HOME/.env" ]; then
    # Check if required variables are referenced in .env
    MISSING_VARS=()

    for var in ${REQUIRED_VARS[@]}; do
        if ! grep -q "$var" "$HOME/.env"; then
            MISSING_VARS+=($var)
        fi
    done
fi
